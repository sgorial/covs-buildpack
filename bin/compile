#!/usr/bin/env bash

echo "Running cache test..."
BUILD_DIR=$1
CACHE_DIR=$2
BUILD_PACK_DIR=$(dirname "$(dirname "$0")")
echo "All arguments [*]"

if [ ! -d "$BUILD_DIR" ]; then
  echo "Build directory [$BUILD_DIR] does not exist, creating"
  mkdir -p "$BUILD_DIR"
else
  echo "Build directory [$BUILD_DIR] exists"
  echo "Build directory contents..."
  ls -lRh "$BUILD_DIR"
fi

if [ ! -d "$CACHE_DIR" ]; then
  echo "Cache directory [$CACHE_DIR] does not exist, creating"
  mkdir -p "$CACHE_DIR"
else
  echo "Cache directory [$CACHE_DIR] exists"
fi

echo "The compile script is at [$0]"
echo "The build pack is situated at [$BUILD_PACK_DIR]"

echo "Moving to the cache dir..."
cd "$CACHE_DIR"
echo "Now in [$(pwd)]"

echo "Directory listing:"
ls -la

echo "Listing Build Pack Directory:"
ls -la /tmp/buildpacks

echo "Listing Build Pack Cache:"
ls -la "$BUILDPACK_CACHE"

echo "Listing Environment:"
env

echo "Listing OS Info:"
cat /etc/issue

echo "Listing script versions:"
python -V
echo
ruby -v
echo
perl -v

echo "User Limits:"
ulimit -a
echo

echo "CPU Info"
cat /proc/cpuinfo

echo "OS Version"
cat /proc/version

echo "Look for staging_info.yml file"
cat "$BUILD_DIR/staging_info.yml"

cd ../

# Download OpenJDK
#mkdir -p "$BUILD_DIR/openjdk/"
#cd "$BUILD_DIR/openjdk/"
#wget http://download.run.pivotal.io/openjdk/mountainlion/x86_64/openjdk-1.8.0_25.tar.gz && tar -xvzf openjdk-1.8.0_25.tar.gz 2<&1

#cd "$BUILD_DIR"

# Download Tomcat container
#wget http://download.run.pivotal.io/tomcat/tomcat-7.0.47.tar.gz && tar -xvzf tomcat-7.0.47.tar.gz
#mv "$BUILD_DIR/apache-tomcat-7.0.47/" "$BUILD_DIR/apache-tomcat/"
#rm -rf "$BUILD_DIR/apache-tomcat/webapps/*"
#cd "$BUILD_DIR/apache-tomcat/webapps/"
#wget https://www.dropbox.com/s/53m264u0oxv5tan/tif-cca-3.28.1.war
#mv tif-cca-3.28.1.war ROOT.war
ldd --version

echo "Creating start script"
cat > "$BUILD_DIR/start.sh" <<EOF
#!/bin/bash
#

wget https://www.dropbox.com/s/8pplwjs9bju4mfb/compiled_source.tar.gz && tar -xvzf compiled_source.tar.gz
ls -lrt
chown -R vcap:vcap apache/
ls -lrt
perl -i -pe 's/VCAP_PORT/'\$PORT'/' /home/vcap/app/apache/conf/httpd.conf
perl -i -pe 's/daemon/vcap' /home/vcap/app/apache/conf/httpd.conf
perl -i -pe 's/VCAP_PORT/'\$PORT'/' /home/vcap/app/apache/conf/extra/httpd-vhosts.conf
#perl -i -pe 's/8080/'\$PORT'/' /home/vcap/app/apache-tomcat/conf/server.xml

curl --silent --location http://heroku-jvm-common.s3.amazonaws.com/jvm-buildpack-common.tar.gz | tar xz
. bin/java

# create default system.properties 
if [ ! -f /home/vcap/app/system.properties ]; then
  echo "java.runtime.version=1.6" > /home/vcap/app/system.properties
fi

# install JDK 
javaVersion=$(detect_java_version /home/vcap/app)
echo -n "-----> Installing OpenJDK ${javaVersion}..."
install_java /home/vcap/app ${javaVersion}
jdk_overlay /home/vcap/app

# Download Tomcat container
wget http://download.run.pivotal.io/tomcat/tomcat-7.0.47.tar.gz && tar -xvzf tomcat-7.0.47.tar.gz
#mv "/home/vcap/app/apache-tomcat-7.0.47/" "/home/vcap/app/apache-tomcat/"
#rm -rf "/home/vcap/app/apache-tomcat/webapps/*"
#cd "/home/vcap/app/apache-tomcat/webapps/"
#wget https://www.dropbox.com/s/53m264u0oxv5tan/tif-cca-3.28.1.war
#mv tif-cca-3.28.1.war ROOT.war
#rm tomcat-7.0.47.tar.gz

#sh -x /home/vcap/app/apache-tomcat-7.0.47/bin/catalina.sh start
sh -x /home/vcap/app/apache/bin/apachectl start
#sh -x /home/vcap/app/apache/bin/apachectl restart
netstat -ap
ps
printenv

EOF
chmod 755 "$BUILD_DIR/start.sh"
